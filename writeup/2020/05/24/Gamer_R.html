<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- title will be injected from _config.yml -->
  <!-- Stylesheets -->
  
  <link rel="stylesheet" href="/assets/css/bootstrap.css">
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="stylesheet" href="/assets/css/responsive.css">
  <link rel="stylesheet" href="/assets/css/import_custom.css">

  <link rel="shortcut icon" href="images/favicon.png" type="image/x-icon">
  <link rel="icon" href="images/favicon.png" type="image/x-icon">

  <!-- Responsive -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <!--[if lt IE 9]><script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script><![endif]-->
  <!--[if lt IE 9]><script src="js/respond.js"></script><![endif]--><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Gamer R | LetzPwn - Luxembourgish CTF Team</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="Gamer R" />
<meta name="author" content="Trigleos" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Gamer R" />
<meta property="og:description" content="Gamer R" />
<link rel="canonical" href="/writeup/2020/05/24/Gamer_R.html" />
<meta property="og:url" content="/writeup/2020/05/24/Gamer_R.html" />
<meta property="og:site_name" content="LetzPwn - Luxembourgish CTF Team" />
<meta property="og:image" content="/img/duck.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-05-24T18:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="/img/duck.png" />
<meta property="twitter:title" content="Gamer R" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Trigleos"},"dateModified":"2020-05-24T18:00:00+00:00","datePublished":"2020-05-24T18:00:00+00:00","description":"Gamer R","headline":"Gamer R","image":"/img/duck.png","mainEntityOfPage":{"@type":"WebPage","@id":"/writeup/2020/05/24/Gamer_R.html"},"url":"/writeup/2020/05/24/Gamer_R.html"}</script>
<!-- End Jekyll SEO tag -->
<link type="application/atom+xml" rel="alternate" href="/feed.xml" title="LetzPwn - Luxembourgish CTF Team" /></head><body>
  <div class="page-wrapper"><!-- Main Header -->
<header class="main-header">
  <!-- Header Top -->
  <div class="header-top">
    <div class="auto-container clearfix">

      <div class="top-left clearfix">
        <ul class="info-list">
          <li>The first Luxembourgish CTF Team</li>
        </ul>
      </div>

      <div class="top-right">
        <ul class="social-icons">
          <li><a href="https://twitter.com/LetzPwn"><span class="fab fa-twitter"></span></a></li>
          <li><a href="https://discord.gg/Qjt5zUc"><span class="fab fa-discord"></span></a></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Header Upper -->
  <div class="header-upper">
    <div class="inner-container">
      <div class="auto-container clearfix">
        <!--Logo-->
        <div class="logo-outer">
          <div class="logo"><a href="/"><img src="/assets/images/logo.png" alt=""
                title="Gamon - Digital Gaming and Esports HTML Template" style="max-width: 260px;"></a></div>
        </div>

        <!--Nav Box-->
        <div class="nav-outer clearfix">
          <!--Mobile Navigation Toggler-->
          <div class="mobile-nav-toggler"><span class="icon flaticon-menu-1"></span></div>

          <!-- Main Menu -->
          <nav class="main-menu navbar-expand-md navbar-light">
            <div class="collapse navbar-collapse show clearfix" id="navbarSupportedContent">
              <ul class="navigation clearfix pull-left">
                
                
                <li class=""><a href="/">Home</a>
                </li>
                
                
                
                <li class=""><a href="/about_us.html">About Us</a>
                </li>
                
                
                
                <li class=""><a href="/events.html">News & CTFs</a>
                </li>
                
                
              </ul>

                <ul class="navigation clearfix pull-right">
                  
                    
                    <li class=""><a href="/sponsors.html">Sponsors</a> </li>
                    
                  
                    
                    <li class=""><a href="/writeups.html">Writeups</a> </li>
                    
                  
                    
                    <li class=""><a href="/contact.html">Contact</a> </li>
                    
                  
                </ul>
            </div>
          </nav>
          <!-- Main Menu End-->
        </div>
      </div>
    </div>
  </div>
  <!--End Header Upper-->

  <!-- Sticky Header  -->
  <div class="sticky-header">
    <div class="auto-container clearfix">
      <!--Logo-->
      <div class="logo pull-left">
        <a href="/" title=""><img src="/assets/images/logo.png" style="max-width:100px;" alt="" title=""></a>
      </div>
      <!--Right Col-->
      <div class="pull-right">
        <!-- Main Menu -->
        <nav class="main-menu clearfix">
          <!--Keep This Empty / Menu will come through Javascript-->
        </nav><!-- Main Menu End-->
      </div>
    </div>
  </div><!-- End Sticky Menu -->

  <!-- Mobile Menu  -->
  <div class="mobile-menu">
    <div class="menu-backdrop"></div>
    <div class="close-btn"><span class="icon flaticon-close"></span></div>

    <nav class="menu-box">
      <div class="nav-logo"><a href="/"><img src="/assets/images/logo.png" alt="" title=""></a></div>
      <div class="menu-outer">
        <!--Here Menu Will Come Automatically Via Javascript / Same Menu as in Header-->
      </div>
      <!--Social Links--
      <div class="social-links">
        <ul class="clearfix">
          <li><a href="#"><span class="fab fa-twitter"></span></a></li>
          <li><a href="#"><span class="fab fa-facebook-square"></span></a></li>
          <li><a href="#"><span class="fab fa-pinterest-p"></span></a></li>
          <li><a href="#"><span class="fab fa-instagram"></span></a></li>
          <li><a href="#"><span class="fab fa-youtube"></span></a></li>
        </ul>
      </div>-->
    </nav>
  </div><!-- End Mobile Menu -->
</header>
<!--Page Title-->
<div itemscope itemtype="http://schema.org/BlogPosting">
  <section class="page-banner" style="padding-bottom: 40px; background-image:url(/assets/images/background/1.png);">
    <div class="auto-container">
      <div class="inner-container clearfix">
        <ul class="bread-crumb clearfix">
          <li><a href="/index.html">Home</a></li> 
          <li><a href="/writeups.html">Writeups</a></li>
          <li><a href="#">TJCTF 2020</a></li> <!-- TODO: correct href-->
          <li itemprop="name headline">Gamer R Writeup</li>
        </ul>
        <h1>Gamer R Writeup</h1><ul class="custom-author">
                <li>By <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span
                      class="p-author h-card" itemprop="name">Trigleos</span></span>
                </li>
              </ul>
              <br/><div class="custom-date">May 24, 2020</div>
        <ul class="tags">
          <li>Solves:  teams</li>
          <li>Source: <a href="" target="_blank" rel="noopener noreferrer"></a></li>
        </ul>
    </div>
  </section>
  <!--End Page Title-->

  <!--Sidebar Page Container-->
  <div class="sidebar-page-containe" style="padding-top: 40px; background-color:#202020">
    <div class="auto-container">
      <div class="row clearfix">

        <!--Content Side / Blog Detail-->
        <div class="content-side col-lg-8 col-md-12 col-sm-12">
          <div class="blog-detail">
            <div class="lower-content writeup-content awsm" style="padding-top: 0px;">
              <p> <h1 id="gamer-r">Gamer R</h1>

<h2 id="tldr">TL;DR</h2>
<p>Reverse a Unity game and patch it to get the flag</p>
<h2 id="description">Description</h2>
<p>This challenge was the last Reversing challenge for TJCTF and gave 80 points. The challenge provided you with a folder that contained a binary as well as several Unity related files and libraries. The game itself was pretty simple. All you had to do was hit space to shoot a knife and hit an orange, all while trying to avoid hitting the ducks swimming randomly in between.
If you manage to hit the orange, your score gets increased by 1.</p>

<p><img src="img/game.gif" alt="game" /></p>

<p>When hitting a duck, your score gets reset to zero,</p>

<p><img src="img/gameover.gif" alt="gameover" /></p>

<p>which means that we probably need to reach a certain score to get the flag. Unity games are normally written in C# which is an interpreted language that generates a bytecode instead of machine code which means that we can easily decompile it. I’ll use dnSpy to decompile the program.</p>

<h2 id="reversing">Reversing</h2>
<p>Unity stores the game logic in <em>Projectname</em>_Data/Managed/Assembly-CSharp.dll so let’s open it in dnSpy</p>

<p><img src="img/dnSpy.png" alt="dnSpy" /></p>

<p>Let’s try to make the game easier by changing the duck collision behaviour described in the class DuckCollisionSystem.
The important part of the code looks like this:</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span>  <span class="p">(</span><span class="n">Vector2</span><span class="p">.</span><span class="nf">Distance</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">ducks</span><span class="p">.</span><span class="n">Transforms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">,</span>  <span class="k">this</span><span class="p">.</span><span class="n">knife</span><span class="p">.</span><span class="n">Transforms</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">position</span><span class="p">)</span>  <span class="p">&lt;</span>  <span class="k">this</span><span class="p">.</span><span class="n">hitBoxRadius</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">...</span>
	<span class="nf">collision</span><span class="p">()</span>
	<span class="p">...</span>
<span class="p">}</span>
<span class="k">private</span>  <span class="kt">float</span>  <span class="n">hitBoxRadius</span>  <span class="p">=</span>  <span class="m">0.6f</span><span class="p">;</span>
</code></pre></div></div>
<p>The code basically checks if the distance between a duck and the knife is smaller than  the specified hitbox radius. If yes, a collision is detected. We can easily bypass this check by changing the value of the hitBoxRadius variable</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span>  <span class="kt">float</span>  <span class="n">hitBoxRadius</span>  <span class="p">=</span>  <span class="p">-</span><span class="m">1.0f</span><span class="p">;</span>
</code></pre></div></div>

<p>After recompiling the code, we can now shoot as many knives as we want without hitting any duck. While I was playing the patched version, I noticed that the score showed a letter instead of a number every multiple of 20, so I played a while to see if the flag would show up.</p>

<p><img src="img/hacked.gif" alt="patched" /></p>

<p>The issue however was that the encoded text was really long and it took me ages to reach each character. So I decided to take a look at the KnifeMoveSystem class which also dealt with increasing the score</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span>  <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">knife</span><span class="p">.</span><span class="n">Transforms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">.</span><span class="n">y</span>  <span class="p">&gt;</span>  <span class="m">4f</span><span class="p">)</span>  
<span class="p">{</span>  
	<span class="p">...</span>
	<span class="k">this</span><span class="p">.</span><span class="n">score</span><span class="p">.</span><span class="n">ScoreComponents</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">Score</span><span class="p">++;</span>  
	<span class="k">this</span><span class="p">.</span><span class="n">score</span><span class="p">.</span><span class="n">ScoreComponents</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">CumScore</span>  <span class="p">+=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="n">score</span><span class="p">.</span><span class="n">ScoreComponents</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">Score</span><span class="p">;</span>
	<span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>
<p>The code checked if a knife had reached the orange and increased the score by one and the CumScore by score. I decided to try and change the value by which Score is increased to 20 and recompiled the code</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="n">score</span><span class="p">.</span><span class="n">ScoreComponents</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">Score</span> <span class="p">+=</span> <span class="m">20</span><span class="p">;</span>  
</code></pre></div></div>
<p>However this led to an issue and the characters didn’t show up right</p>

<p><img src="img/problem.gif" alt="bug" /></p>

<p>So I took a look inside the scoreUpdateSystem class to see what the problem was about</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span>  <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">ScoreComponents</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Score</span>  <span class="p">/</span>  <span class="m">20</span>  <span class="p">&lt;</span>  <span class="k">this</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">ScoreComponents</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">TextSeq</span><span class="p">.</span><span class="n">Length</span>  <span class="p">&amp;&amp;</span>  <span class="k">this</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">ScoreComponents</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Score</span>  <span class="p">%</span>  <span class="m">20</span>  <span class="p">==</span>  <span class="m">0</span><span class="p">)</span>  
<span class="p">{</span>  
	<span class="k">this</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">Texts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">text</span>  <span class="p">=</span>  <span class="p">((</span><span class="kt">char</span><span class="p">)(</span><span class="k">this</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">ScoreComponents</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">TextSeq</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">ScoreComponents</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Score</span>  <span class="p">/</span>  <span class="m">20</span><span class="p">]</span>  <span class="p">^</span>  <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="k">this</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">ScoreComponents</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">CumScore</span>  <span class="p">%</span>  <span class="m">4096.0</span><span class="p">))).</span><span class="nf">ToString</span><span class="p">();</span>  
<span class="p">}</span>
</code></pre></div></div>
<p>This part checked whether the score was divisible by 20 and if so, it xored a value in the TextSeq array with the CumScore value and put the result into the UI score field. That meant that I had to fix the cumScore value as well when I increased the score by 20 as the cumScore would have normally increased by every integer between 0 and 20. A quick way to do this is to use the formula to calculate a triangular number which basically sums up to :
cumScore = ((score)*(score+1))/2
Implemented in C# this gives us:</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">this</span><span class="p">.</span><span class="n">score</span><span class="p">.</span><span class="n">ScoreComponents</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">CumScore</span>  <span class="p">=</span>  <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="n">score</span><span class="p">.</span><span class="n">ScoreComponents</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">Score</span>  <span class="p">*</span>  <span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="n">score</span><span class="p">.</span><span class="n">ScoreComponents</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">Score</span>  <span class="p">+</span>  <span class="m">1.0</span><span class="p">)</span>  <span class="p">/</span>  <span class="m">2.0</span><span class="p">;</span>
</code></pre></div></div>
<p>Recompiling the game gives us a working patch that gets us the flag way faster</p>

<p><img src="img/solution.gif" alt="solution" /></p>

<p>The letters found in the score field build up following text:
HERE’S THE FLAG YOU’RE LOOKING FOR! HAHA JKJK… UNLESS…? TJCTF{ORENJI_MANGGOE}
and we have our flag</p>
</p>
            </div>
          </div>

          <!-- Other Options -->
          <div class="post-share-options clearfix">
            <!--
            <div class="pull-left">
              <ul class="tags">
                <li><a href="#">Gaming</a></li>
                <li><a href="matches.html">Matches</a></li>
                <li><a href="#">Players</a></li>
              </ul>
            </div>
            -->
            <!--
            <div class="social-links pull-right">
              <ul class="social-links">
                <li><a href="#"><span class="fab fa-twitter"></span></a></li>
                <li><a href="#"><span class="fab fa-facebook-square"></span></a></li>
                <li><a href="#"><span class="fab fa-pinterest-p"></span></a></li>
                <li><a href="#"><span class="fab fa-instagram"></span></a></li>
              </ul>
            </div>
            -->
          </div>
        </div>

        <!--Sidebar Side-->
        <div class="sidebar-side col-lg-4 col-md-12 col-sm-12">
          <aside class="sidebar">

            <!-- Tags Widget -->
            <div class="sidebar-widget popular-tags">
              <div class="widget-content">
                <h4 class="sidebar-title">Task categories</h4>
                
                  <a href="#">Reversing</a>
                
              </div>
            </div>

            <!-- Search -->
            <!--
            <div class="sidebar-widget search-box">
              <form method="post" action="contact.html">
                <div class="form-group">
                  <input type="search" name="search-field" value="" placeholder="Search" required>
                  <button type="submit"><span class="icon fa fa-search"></span></button>
                </div>
              </form>
            </div>
            -->

            <!-- Post Widget -->
            <div class="sidebar-widget popular-posts">
              <div class="widget-content">
                <h4 class="sidebar-title">Recent Writeups</h4>
                
                
                
                
                
                
                
                
                
                <article class="post">
                  <div class="post-inner">
                    
                    
                    <figure class="post-thumb"><a href="/writeup/2019/10/27/Numtonce.html"><img src="/writeup/2019/10/27/website.png"
                          alt=""></a></figure>
                    <div class="post-info">May 24, 2020</div>
                    <div class="text"><a href="/writeup/2019/10/27/Numtonce.html">Numtonce</a></div>
                  </div>

                </article>
                
                
                
                <article class="post">
                  <div class="post-inner">
                    
                    
                    <figure class="post-thumb"><a href="/writeup/2020/02/05/Draw_with_us.html"><img src="/writeup/2020/02/05/website.png"
                          alt=""></a></figure>
                    <div class="post-info">May 24, 2020</div>
                    <div class="text"><a href="/writeup/2020/02/05/Draw_with_us.html">Draw with us</a></div>
                  </div>

                </article>
                
                
              </div>
            </div>

            <!-- Category Widget -->
            <!--
            <div class="sidebar-widget categories">
              <div class="widget-content">
                <h4 class="sidebar-title">Categories</h4>
                <ul class="blog-categories">
                  <li><a href="blog-single.html">Gaming</a></li>
                  <li><a href="blog-single.html">Matches</a></li>
                  <li><a href="blog-single.html">Video games</a></li>
                  <li><a href="blog-single.html">Esports</a></li>
                  <li><a href="blog-single.html">Champions</a></li>
                </ul>
              </div>
            </div>
            -->
          </aside>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- End Sidebar Page Container -->

	<!-- Main Footer -->
  <footer class="main-footer">
    	<div class="auto-container">
        	<!--Widgets Section-->
            <div class="widgets-section">
            	<div class="row clearfix">
                	
                    <!--Column-->
                    <div class="column col-lg-4 col-md-6 col-sm-12">
						<div class="footer-widget logo-widget">
							<div class="logo">
                            	<a href="/index.html"><img src="/assets/images/logo.png" alt="" /></a>
                            </div>
							<div class="text"></div>
						</div>
					</div>
					
					<!--Column-->
                    <div class="column col-lg-4 col-md-6 col-sm-12">
						<div class="footer-widget links-widget">
							<div class="widget-content">
								<div class="footer-title">
									<h2>Links</h2>
								</div>
								<div class="row clearfix">
									<div class="column col-lg-6 col-md-6 col-sm-12">
										<ul class="list">
											<li><a href="/about_us.html">About</a></li>
											<li><a href="/members.html">Our Team</a></li>
											<li><a href="/events.html">News and CTFs</a></li>
											<li><a href="/contact.html">Contact</a></li>
										</ul>
									</div>
									<div class="column col-lg-6 col-md-6 col-sm-12">
										<ul class="list">
											<li><a href="/contact.html">Help & Support</a></li>
											<li><a href="/privacy_policy.html">Privacy Policy</a></li>
										</ul>
									</div>
								</div>
							</div>	
						</div>
					</div>
					
					<!--Column                    <div class="column col-lg-4 col-md-6 col-sm-12">
						<div class="footer-widget newsletter-widget">
							<div class="footer-title">
                            	<h2>Newsletter</h2>
                            </div>
							<div class="text">Subsrcibe us now to get the latest news and updates</div>
							<div class="newsletter-form">
                                <form method="post" action="contact.html">
                                    <div class="form-group clearfix">
                                        <input type="email" name="email" value="" placeholder="Email address" required>
                                        <button type="submit" class="theme-btn newsletter-btn"><span class="fas fa-envelope"></span></button>
                                    </div>
                                </form>
                            </div>
						</div>
					</div>
					-->

				</div>
			</div>
		</div>
		
		<!-- Footer Bottom -->
		<div class="footer-bottom">
			<div class="auto-container">
				<!--Scroll to top-->
				<div class="scroll-to-top scroll-to-target" data-target="html"><span class="flaticon-up-arrow"></span></div>
				<!--Scroll to top-->
				<div class="row clearfix">
					<!-- Column -->
					<div class="column col-lg-6 col-md-12 col-sm-12">
						<div class="copyright">&copy; Copyrights, 2019 All Rights Reserved</div>
					</div>
					<!-- Column -->
					<div class="column col-lg-6 col-md-12 col-sm-12">
						<ul class="social-icons">
							<li><a href="https://twitter.com/letzpwn"><span class="fab fa-twitter"></span></a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		
  </footer>
  
</div>
<script src="/assets/js/jquery.js"></script>
<script src="/assets/js/popper.min.js"></script>
<script src="/assets/js/bootstrap.min.js"></script>
<script src="/assets/js/jquery-ui.js"></script>
<script src="/assets/js/jquery.fancybox.js"></script>
<script src="/assets/js/owl.js"></script>
<script src="/assets/js/appear.js"></script>
<script src="/assets/js/wow.js"></script>
<script src="/assets/js/scrollbar.js"></script>
<script src="/assets/js/script.js"></script></body>

</html>